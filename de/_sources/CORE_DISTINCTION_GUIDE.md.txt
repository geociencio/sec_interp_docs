# Gu√≠a de Distinci√≥n de Componentes "Core"

Este documento tiene como objetivo aclarar la distinci√≥n entre los diferentes componentes denominados "Core" dentro del proyecto **SecInterp**, para evitar confusiones tanto por parte de desarrolladores humanos como de agentes de IA.

## ‚ö†Ô∏è La Distinci√≥n Fundamental

Existen dos entidades "Core" que coexisten en este entorno de desarrollo:

1.  **SecInterp Core** (El N√∫cleo del Proyecto):
    *   **Ubicaci√≥n**: Directorio `/core` dentro de la ra√≠z del proyecto.
    *   **Prop√≥sito**: Contiene la l√≥gica de negocio pura, algoritmos geol√≥gicos, servicios de procesamiento y modelos de datos (DTOs) espec√≠ficos de SecInterp.
    *   **Estado Actual**: **Desacoplado**. A partir de la versi√≥n 2.8.0, este m√≥dulo ha sido saneado para no tener dependencias directas de las clases vivas de QGIS durante el procesamiento pesado (Thread-Safe).

2.  **QGIS Core** (La API de QGIS):
    *   **Referencia**: Paquete de Python `qgis.core`.
    *   **Prop√≥sito**: Proporciona la infraestructura geoespacial subyacente (geometr√≠as, capas, proyectos, CRS).
    *   **Interacci√≥n**: SecInterp utiliza `qgis.core` para extraer datos en el hilo principal, pero el **SecInterp Core** procesa estos datos usando tipos agn√≥sticos (WKT, diccionarios, primitivos).

---

## üß≠ Reglas para Desarrolladores e IA

Para mantener la integridad arquitect√≥nica, siga estas directrices:

### 1. No asuma que "Core" siempre es QGIS
Si se le pide "revisar el core", se refiere casi exclusivamente al directorio `/core` de este plugin. No intente buscar o modificar archivos internos del motor de QGIS.

### 2. L√≠mites de Datos (Decoupling)
*   **En `/core`**: Se deben usar tipos de dominio agn√≥sticos. Evite instanciar `QgsVectorLayer` o acceder a `QgsProject.instance()` dentro de los servicios del n√∫cleo. Use `DomainGeometry` (WKT) y diccionarios de atributos.
*   **En `/gui`**: Es el lugar donde se realiza la traducci√≥n entre la API real de QGIS (`qgis.core`) y el **SecInterp Core**. Aqu√≠ es donde se extraen las geometr√≠as y se preparan los DTOs.

### 3. Nomenclatura de Archivos e Importaciones
*   **Archivos Locales**: Los archivos en `core/` (ej. `core/services/geology_service.py`) son el **Cerebro de SecInterp**.
*   **API Externa**: Las importaciones que empiezan con `qgis.core`, `qgis.gui` o `qgis.utils` son **Dependencias Externas**.
*   **Regla de Nomenclatura**: En discusiones o comentarios de c√≥digo, use "Internal Core" para referirse a `/core` y "PyQGIS API" para la del software.

### 4. El Patr√≥n "Extract-then-Compute" (Extraer y Calcular)
Para evitar complicaciones futuras, el flujo de datos **DEBE** seguir este patr√≥n:
1.  **Capa GUI/Task Interface**: Recibe objetos de QGIS (`QgsVectorLayer`, `QgsFeature`). Extrae lo necesario (geometr√≠a en WKT, diccionarios de atributos).
2.  **Capa Core**: Recibe √∫nicamente los datos extra√≠dos (strings, dicts, floats). Realiza los c√°lculos geom√©tricos pesados.
3.  **Resultado**: El Core devuelve DTOs (Data Transfer Objects) definidos en `core/types.py`. La capa GUI se encarga de convertir esto de nuevo a capas de QGIS si es necesario.

### 5. Reglas de Oro de Hilo-Seguridad (Thread-Safety)
*   **Prohibido**: Importar `qgis.gui` dentro de `core/`. Los hilos de fondo morir√°n si intentan tocar cualquier widget o ventana.
*   **Restricci√≥n**: Minimizar el uso de `qgis.core` dentro de `core/`. Aunque algunas clases como `QgsGeometry` son seguras, es preferible operar sobre WKT para garantizar total independencia.
*   **Contexto de Aplicaci√≥n**: Nunca use `iface` o `QgsProject.instance()` dentro de `core/`. Si necesita datos del proyecto, p√°selos como argumentos pre-extra√≠dos.

---

## üß™ Estrategia de Testing Diferenciada

*   **Tests del Core (`tests/core/`)**: Deben poder ejecutarse sin instalar QGIS completo. Usan mocks ligeros. Son el term√≥metro de la l√≥gica geol√≥gica.
*   **Tests de Integraci√≥n (`tests/integration/`)**: Requieren QGIS real. Prueban que nuestro "Core" se entiende correctamente con la "API de QGIS".

---

## üõ†Ô∏è Resumen de Desacoplamiento (Enero 2026)

Se ha completado un esfuerzo mayor para asegurar que:
*   `GeologyService` no use capas vivas de QGIS en su m√©todo de procesamiento.
*   `DrillholeService` use diccionarios en lugar de objetos `QgsFeature` durante el c√°lculo de trazas.
*   La l√≥gica de proyecci√≥n 3D acepta tuplas y tipos primitivos.

**En resumen: Mantenga nuestro Core "puro". Trate a QGIS como un proveedor de servicios externo. No permita que las ra√≠ces de uno entren en la l√≥gica del otro.**
